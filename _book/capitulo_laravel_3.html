<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>Laravel 3. Base de datos | Introducción</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.0.3">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="next" href="./capitulo_laravel_4.html" />
    
    
    <link rel="prev" href="./capitulo_laravel_2.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="gitbook/style.css">


        
    <div class="book"  data-level="14" data-basepath="." data-revision="1422271212353">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="./index.html">
                        <i class="fa fa-check"></i>
                        
                         Introducción
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="capitulo_introduccion_web.html">
            
                
                    <a href="./capitulo_introduccion_web.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         Introducción al desarrollo Web
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="capitulo_introduccion_javascript.html">
            
                
                    <a href="./capitulo_introduccion_javascript.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         Introducción a JavaScript
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="capitulo_diseno_responsive.html">
            
                
                    <a href="./capitulo_diseno_responsive.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         Diseño Responsive
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="capitulo_diseno_responsive_avanzado.html">
            
                
                    <a href="./capitulo_diseno_responsive_avanzado.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         Diseño Responsive avanzado
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="capitulo_jquery_mobile.html">
            
                
                    <a href="./capitulo_jquery_mobile.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         JQuery Mobile
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="capitulo_jquery_mobile_avanzado.html">
            
                
                    <a href="./capitulo_jquery_mobile_avanzado.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         JQuery Mobile avanzado
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="7" data-path="capitulo_sencha_touch_1.html">
            
                
                    <a href="./capitulo_sencha_touch_1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                         Sencha Touch 1. Introducción
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="8" data-path="capitulo_sencha_touch_2.html">
            
                
                    <a href="./capitulo_sencha_touch_2.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                         Sencha Touch 2. Componentes
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="9" data-path="capitulo_sencha_touch_3.html">
            
                
                    <a href="./capitulo_sencha_touch_3.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                         Sencha Touch 3. Almacenamiento
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="10" data-path="capitulo_phonegap.html">
            
                
                    <a href="./capitulo_phonegap.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                         PhoneGap 1. Introducción
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="11" data-path="capitulo_phonegap_avanzado.html">
            
                
                    <a href="./capitulo_phonegap_avanzado.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                         PhoneGap 2. Avanzado
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12" data-path="capitulo_laravel_1.html">
            
                
                    <a href="./capitulo_laravel_1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                         Laravel 1. Introducción
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13" data-path="capitulo_laravel_2.html">
            
                
                    <a href="./capitulo_laravel_2.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                         Laravel 2. Controladores, filtros y formularios
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="14" data-path="capitulo_laravel_3.html">
            
                
                    <a href="./capitulo_laravel_3.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                         Laravel 3. Base de datos
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="15" data-path="capitulo_laravel_4.html">
            
                
                    <a href="./capitulo_laravel_4.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                         Laravel 4. Datos de entrada y control de usuarios
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="16" data-path="capitulo_laravel_5.html">
            
                
                    <a href="./capitulo_laravel_5.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                         Laravel 5. Paquetes, Rest y Curl
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="17" data-path="capitulo_rest.html">
            
                
                    <a href="./capitulo_rest.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                         Servicios Rest
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="./" >Introducción</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_11">
                    
                        <h1 id="laravel-3---base-de-datos">Laravel 3 - Base de datos</h1>
<!-- ************************************************************************-->
<h1 id="base-de-datos">Base de Datos</h1>
<p>Laravel facilita la configuración y el uso de diferentes tipos de base de datos: MySQL, Postgres, SQLite y SQL Server. En el fichero de configuración (<code>app/config/database.php</code>) tenemos que indicar todos los parámetros de acceso a nuestras bases de datos y además especificar cual es la conexión que se utilizará por defecto. En Laravel podemos hacer uso de varias bases de datos a la vez, aunque sean de distinto tipo. Por defecto se accederá a la que especifiquemos en la configuración y si queremos acceder a otra conexión lo tendremos que indicar expresamente al realizar la consulta. </p>
<!-- *********************************** -->
<h2 id="configuracin-de-la-base-de-datos">Configuración de la Base de Datos</h2>
<p>Como ejemplo vamos a configurar el acceso a una base de datos tipo MySQL. 
Editamos <code>app/config/database.php</code> y actualizamos los campos <em>database</em>, <em>username</em> y <em>password</em> de la sección de mysql con los valores apropiados para acceder a nuestra base de datos:</p>
<pre><code class="lang-php"><span class="hljs-string">'mysql'</span> =&gt; <span class="hljs-keyword">array</span>(
    <span class="hljs-string">'driver'</span>    =&gt; <span class="hljs-string">'mysql'</span>,
    <span class="hljs-string">'host'</span>      =&gt; <span class="hljs-string">'localhost'</span>,
    <span class="hljs-string">'database'</span>  =&gt; <span class="hljs-string">'laravel'</span>,       <span class="hljs-comment">// Nombre de la base de datos</span>
    <span class="hljs-string">'username'</span>  =&gt; <span class="hljs-string">'root'</span>,          <span class="hljs-comment">// Usuario de acceso a la base de datos</span>
    <span class="hljs-string">'password'</span>  =&gt; <span class="hljs-string">''</span>,              <span class="hljs-comment">// Contraseña de acceso</span>
    <span class="hljs-string">'charset'</span>   =&gt; <span class="hljs-string">'utf8'</span>,
    <span class="hljs-string">'collation'</span> =&gt; <span class="hljs-string">'utf8_unicode_ci'</span>,
    <span class="hljs-string">'prefix'</span>    =&gt; <span class="hljs-string">''</span>,
),
</code></pre>
<p>Para crear la base de datos que vamos a utilizar en MySQL podemos utilizar la herramienta <em>PHPMyAdmin</em> que se ha instalado con el paquete XAMPP. Para esto accedemos a la ruta:</p>
<pre><code class="lang-bash">http://localhost/phpmyadmin
</code></pre>
<p>La cual nos mostrará un panel para la gestión de las bases de datos de MySQL, que nos permite, además de realizar cualquier tipo de consulta SQL, crear nuevas bases de datos o tablas, e insertar, modificar o eliminar los datos directamente. En nuestro caso apretamos en la pestaña &quot;Bases de datos&quot; y creamos una nueva base de datos llamada &quot;laravel&quot; (igual que hemos indicado antes en el fichero de configuración de Laravel).</p>
<p>A continuación vamos a crear la tabla de migraciones (en la siguiente sección veremos que es esto) en la nueva base de datos ejecutando el siguiente comando de Artisan:</p>
<pre><code class="lang-bash">php artisan migrate:install
</code></pre>
<p>Si ahora vamos al navegador y actualizamos nuestra base de datos en PHPMyAdmin podremos ver que se nos habrá creado la tabla <code>migrations</code>. Con esto ya tenemos configurada la base de datos y el acceso a la misma. En las siguientes secciones veremos como añadir tablas a esta base de datos y posteriormente como realizar consultas. </p>
<!-- ************************************************************************-->
<h1 id="migraciones">Migraciones</h1>
<p>Las migraciones son un sistema de control de versiones para bases de datos. Permiten que un equipo trabaje sobre una base de datos añadiendo y modificando campos, manteniendo un histórico de los cambios realizados y del estado actual de la base de datos. Las migraciones se utilizan de forma conjunta con la herramienta <em>Schema builder</em> (que veremos en la siguiente sección) para gestionar el esquema de base de datos de la aplicación. </p>
<p>La forma de funcionar de las migraciones es crear ficheros (PHP) con la descripción de la tabla a crear y posteriormente, si se quiere modificar dicha tabla se añadiría una nueva migración (un nuevo fichero PHP) con los campos a modificar. Artisan incluye comando para crear migraciones, para ejecutar las migraciones o para hacer <em>rollback</em> de las mismas (volver atrás). </p>
<p>Para crear una nueva migración se utiliza el comando de Artisan <code>migrate:make</code>, al cual le pasaremos el nombre del fichero a crear y el nombre de la tabla: </p>
<pre><code class="lang-bash">php artisan migrate:make create_users_table --create=users
</code></pre>
<p>Esto nos creará un fichero de migración en la carpeta <code>app/database/migrations</code> con el nombre <code>&lt;TIMESTAMP&gt;_create_users_table.php</code>. Al añadir un <em>timestamp</em> a las migraciones el sistema sabe el orden en el que tiene que ejecutar (o deshacer) las mismas. </p>
<p>Si lo que queremos es añadir una migración que actualice los campos de una tabla existente tendremos que ejecutar el siguiente comando: </p>
<pre><code class="lang-bash">php artisan migrate:make add_votes_to_user_table --table=users
</code></pre>
<p>En este caso se creará también un fichero en la misma carpeta, con el nombre <code>&lt;TIMESTAMP&gt;_add_votes_to_user_table.php</code> pero preparado para modificar los campos de dicha tabla. </p>
<p>Por defecto, al indicar el nombre del fichero de migraciones se suele seguir siempre el mismo patrón (aunque el realidad el nombre es libre). Si es una migración que crea una tabla el nombre tendrá que ser <code>create_&lt;table-name&gt;_table</code> y si es una migración que modifica una tabla será <code>&lt;action&gt;_to_&lt;table-name&gt;_table</code>.</p>
<p>El fichero generado para una migración siempre tiene una estructura similar a la siguiente: </p>
<pre><code class="lang-php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateUsersTable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span> 
</span>{
    <span class="hljs-comment">/**
     * Run the migrations.
     *<span class="hljs-phpdoc"> @return</span> void
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-comment">//</span>
    }

    <span class="hljs-comment">/**
     * Reverse the migrations.
     *<span class="hljs-phpdoc"> @return</span> void
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-comment">//</span>
    }
}
</code></pre>
<p>En el método <code>up</code> es donde tendremos crear o modificar la tabla, y en el método <code>down</code> tendremos que deshacer los cambios que se hagan en el <code>up</code> (eliminar la tabla o eliminar el campo que se haya añadido). Esto nos permitirá poder ir añadiendo y eliminando cambios sobre la base de datos y tener un control o histórico de los mismos. </p>
<p>Después de crear una migración y de definir la tabla que tiene que crear o los campos que tiene que modificar (en la siguiente sección veremos como especificar esto) tenemos que lanzar la migración con el siguiente comando: </p>
<pre><code class="lang-bash">php artisan migrate
</code></pre>
<p>Este comando aplicará la migración sobre la base de datos. Posteriormente en caso de que queramos deshacer estos cambios (los últimos) podremos ejecutar: </p>
<pre><code class="lang-bash">php artisan migrate:rollback

<span class="hljs-comment"># O si queremos deshacer todas las migraciones</span>
php artisan migrate:reset
</code></pre>
<p>Un comando interesante cuando estamos desarrollando un nuevo sitio web es <code>migrate:refresh</code>, el cual deshará todos los cambios y volver a aplicar las migraciones: </p>
<pre><code class="lang-bash">php artisan migrate:refresh
</code></pre>
<!-- *********************************** -->
<h2 id="_schema-builder_"><em>Schema Builder</em></h2>
<p>Una vez creada una migración tenemos que completar los métodos <code>up</code> y <code>down</code> de la misma para indicar la tabla que queremos crear o el campo que queremos modificar. Además, en el método <code>down</code> siempre tendremos que añadir la operación inversa, eliminar la tabla que se ha creado en el método <code>up</code> o eliminar la columna que se ha añadido. Esto nos permitirá deshacer migraciones dejando la base de datos en el mismo estado en el que se encontraban antes de que se añadieran.</p>
<p>Para especificar la tabla a crear o modificar así como las columnas y tipos de datos de las mismas se utiliza <em>Schema</em>, la cual tiene una API que nos permite especificar la estructura de las tablas independientemente del sistema de base de datos que utilicemos. </p>
<p>Para añadir una tabla a la base de datos se utiliza el siguiente constructor: </p>
<pre><code class="lang-php">Schema::create(<span class="hljs-string">'users'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-variable">$table</span>)</span>
</span>{
    <span class="hljs-variable">$table</span><span class="hljs-variable">-&gt;increments</span>(<span class="hljs-string">'id'</span>);
});
</code></pre>
<p>Donde, el primer argumento es el nombre de la tabla y el segundo es una función que recibe como parámetro la tabla para que podamos configurar las columnas que va a contener. </p>
<p>En la sección <code>down</code> de la migración tendremos que eliminar la tabla que hemos creado, para esto podemos utilizar alguno de estos métodos: </p>
<pre><code class="lang-php">Schema::drop(<span class="hljs-string">'users'</span>);

Schema::dropIfExists(<span class="hljs-string">'users'</span>);
</code></pre>
<p>Al crear una migración con los comandos que hemos visto en la sección anterior ya nos viene este código añadido por defecto, la creación y eliminación de la tabla que se ha indicado y además se añaden un par de columnas por defecto (<em>id</em> y <em>timestamps</em>). </p>
<p>Como hemos dicho, el constructor <code>Schema::create</code> recibe como segundo parámetro una función que nos permite especificar las columnas que va a tener dicha tabla. En esta función podemos ir añadiendo todos los campos que queramos, indicando para cada uno de ellos su tipo y nombre, y además si queremos también podremos indicar una serie de modificadores como valor por defecto, índices, etc. Por ejemplo: </p>
<pre><code class="lang-php">Schema::create(<span class="hljs-string">'users'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-variable">$table</span>)</span>
</span>{
    <span class="hljs-variable">$table</span><span class="hljs-variable">-&gt;increments</span>(<span class="hljs-string">'id'</span>);
    <span class="hljs-variable">$table</span><span class="hljs-variable">-&gt;string</span>(<span class="hljs-string">'username'</span>, <span class="hljs-number">32</span>);
    <span class="hljs-variable">$table</span><span class="hljs-variable">-&gt;string</span>(<span class="hljs-string">'password'</span>);
    <span class="hljs-variable">$table</span><span class="hljs-variable">-&gt;smallInteger</span>(<span class="hljs-string">'votos'</span>);
    <span class="hljs-variable">$table</span><span class="hljs-variable">-&gt;string</span>(<span class="hljs-string">'direccion'</span>);
    <span class="hljs-variable">$table</span><span class="hljs-variable">-&gt;boolean</span>(<span class="hljs-string">'confirmado'</span>)<span class="hljs-variable">-&gt;default</span>(<span class="hljs-keyword">false</span>);
    <span class="hljs-variable">$table</span><span class="hljs-variable">-&gt;timestamps</span>();
});
</code></pre>
<p><em>Schema</em> define muchos tipos de datos que podemos utilizar para definir las columnas de una tabla, algunos de los principales son: </p>
<table>
<thead>
<tr>
<th>Comando</th>
<th>Tipo de campo</th>
</tr>
</thead>
<tbody>
<tr>
<td>$table-&gt;boolean(&#39;confirmed&#39;);</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>$table-&gt;enum(&#39;choices&#39;, array(&#39;foo&#39;, &#39;bar&#39;));</td>
<td>ENUM</td>
</tr>
<tr>
<td>$table-&gt;float(&#39;amount&#39;);</td>
<td>FLOAT</td>
</tr>
<tr>
<td>$table-&gt;increments(&#39;id&#39;);</td>
<td>Clave principal tipo INTEGER con Auto-Increment</td>
</tr>
<tr>
<td>$table-&gt;integer(&#39;votes&#39;);</td>
<td>INTEGER</td>
</tr>
<tr>
<td>$table-&gt;mediumInteger(&#39;numbers&#39;);</td>
<td>MEDIUMINT</td>
</tr>
<tr>
<td>$table-&gt;smallInteger(&#39;votes&#39;);</td>
<td>SMALLINT</td>
</tr>
<tr>
<td>$table-&gt;tinyInteger(&#39;numbers&#39;);</td>
<td>TINYINT</td>
</tr>
<tr>
<td>$table-&gt;string(&#39;email&#39;);</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>$table-&gt;string(&#39;name&#39;, 100);</td>
<td>VARCHAR con la longitud indicada</td>
</tr>
<tr>
<td>$table-&gt;text(&#39;description&#39;);</td>
<td>TEXT</td>
</tr>
<tr>
<td>$table-&gt;timestamp(&#39;added_on&#39;);</td>
<td>TIMESTAMP</td>
</tr>
<tr>
<td>$table-&gt;timestamps();</td>
<td>Añade los <em>timestamps</em> &quot;created_at&quot; y &quot;updated_at&quot;</td>
</tr>
<tr>
<td>-&gt;nullable()</td>
<td>Indicar que la columna permite valores NULL</td>
</tr>
<tr>
<td>-&gt;default($value)</td>
<td>Declare a default value for a column</td>
</tr>
<tr>
<td>-&gt;unsigned()</td>
<td>Añade UNSIGNED a las columnas tipo INTEGER</td>
</tr>
</tbody>
</table>
<p>Para consultar todos los tipos de datos que podemos utilizar podéis consultar la documentación de Laravel en: </p>
<p><a href="http://laravel.com/docs/4.2/schema#adding-columns" target="_blank">http://laravel.com/docs/4.2/schema#adding-columns</a></p>
<!-- *********************************** -->
<h3 id="aadir-ndices">Añadir índices</h3>
<p><em>Schema</em> soporta los siguientes tipos de índices: </p>
<table>
<thead>
<tr>
<th>Comando</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td>$table-&gt;primary(&#39;id&#39;);</td>
<td>Añadir una clave primaria</td>
</tr>
<tr>
<td>$table-&gt;primary(array(&#39;first&#39;, &#39;last&#39;));</td>
<td>Definir una clave primaria compuesta</td>
</tr>
<tr>
<td>$table-&gt;unique(&#39;email&#39;);</td>
<td>Definir el campo como UNIQUE</td>
</tr>
<tr>
<td>$table-&gt;index(&#39;state&#39;);</td>
<td>Añadir un índice a una columna</td>
</tr>
</tbody>
</table>
<p>En la tabla se especifica como añadir estos índices después de crear el campo, pero también permite indicar estos índices a la vez que se crea el campo: </p>
<pre><code class="lang-php"><span class="hljs-variable">$table</span><span class="hljs-variable">-&gt;string</span>(<span class="hljs-string">'email'</span>)<span class="hljs-variable">-&gt;unique</span>();
</code></pre>
<!-- *********************************** -->
<h3 id="claves-ajenas">Claves ajenas</h3>
<p>Desde <em>Schema</em> también podemos definir claves ajenas entre tablas:</p>
<pre><code class="lang-php"><span class="hljs-variable">$table</span><span class="hljs-variable">-&gt;integer</span>(<span class="hljs-string">'user_id'</span>)<span class="hljs-variable">-&gt;unsigned</span>();
<span class="hljs-variable">$table</span><span class="hljs-variable">-&gt;foreign</span>(<span class="hljs-string">'user_id'</span>)<span class="hljs-variable">-&gt;references</span>(<span class="hljs-string">'id'</span>)<span class="hljs-variable">-&gt;on</span>(<span class="hljs-string">'users'</span>);
</code></pre>
<p>En este ejemplo, en primer lugar añadimos la columna &quot;<code>user_id</code>&quot; de tipo UNSIGNED INTEGER (siempre tendremos que crear primero la columna sobre la que se va a aplicar la clave ajena). A continuación creamos la clave ajena entre la columna &quot;<code>user_id</code>&quot; y la columna &quot;<code>id</code>&quot; de la tabla &quot;<code>users</code>&quot;.</p>
<blockquote>
<p>La columna con la clave ajena tiene que ser del mismo tipo que la columna a la que apunta. Si por ejemplo creamos una columna a un índice auto-incremental tendremos que especificar que la columna sea <em>unsigned</em> para que no se produzcan errores.</p>
</blockquote>
<p>También podemos especificar las acciones que se tienen que realizar para &quot;<em>on delete</em>&quot; y &quot;<em>on update</em>&quot;: </p>
<pre><code class="lang-php"><span class="hljs-variable">$table</span><span class="hljs-variable">-&gt;foreign</span>(<span class="hljs-string">'user_id'</span>)
      <span class="hljs-variable">-&gt;references</span>(<span class="hljs-string">'id'</span>)<span class="hljs-variable">-&gt;on</span>(<span class="hljs-string">'users'</span>)
      <span class="hljs-variable">-&gt;onDelete</span>(<span class="hljs-string">'cascade'</span>);
</code></pre>
<p>Para eliminar una clave ajena, en el método <code>down</code> de la migración tenemos que utilizar el siguiente código:  </p>
<pre><code class="lang-php"><span class="hljs-variable">$table</span><span class="hljs-variable">-&gt;dropForeign</span>(<span class="hljs-string">'posts_user_id_foreign'</span>);
</code></pre>
<p>Para indicar la clave ajena a eliminar tenemos que seguir el siguiente patrón para especificar el nombre <code>&lt;tabla&gt;_&lt;columna&gt;_foreign</code>. Donde &quot;tabla&quot; es el nombre de la tabla actual y &quot;columna&quot; el nombre de la columna sobre la que se creo la clave ajena.</p>
<!-- ************************************************************************-->
<h1 id="inicializacin-de-la-base-de-datos-_database-seeding_">Inicialización de la base de datos (<em>Database Seeding</em>)</h1>
<p>Laravel también facilita la inserción de datos iniciales en la base de datos. Esta opción es muy útil para tener datos de prueba cuando estamos desarrollando una web o para crear tablas que ya tienen que contener una serie de datos iniciales en producción. </p>
<p>Los ficheros de &quot;semillas&quot; se encuentran en la carpeta <code>app/database/seeds</code>. En esta carpeta podemos añadir más ficheros PHP con clases que extiendan de <code>Seeder</code> para definir nuestros propios ficheros de &quot;semillas&quot;. El nombre de los ficheros suele seguir el mismo patrón <code>&lt;nombre-tabla&gt;TableSeeder</code>, por ejemplo &quot;<code>UserTableSeeder</code>&quot;.</p>
<p>Por defecto Laravel incluye el fichero <code>DatabaseSeeder</code>, que será el primero que se llamará. Dentro de su método <code>run</code> tendremos que añadir llamadas a nuestros ficheros de semillas para que se ejecuten. A continuación se incluye un ejemplo: </p>
<pre><code class="lang-php"><span class="hljs-comment">// Clase principal de semillas...</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseSeeder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Seeder</span> 
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-comment">// Llamamos a nuestro fichero de semillas</span>
        <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;call</span>(<span class="hljs-string">'UserTableSeeder'</span>);

        <span class="hljs-comment">// Mostramos información por consola</span>
        <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;command</span><span class="hljs-variable">-&gt;info</span>(<span class="hljs-string">'User table seeded!'</span>);
    }
}

<span class="hljs-comment">// Nuestro fichero de semillas</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserTableSeeder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Seeder</span> 
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-comment">// Dentro del método run es donde tenemos que inicializar la tabla</span>

        <span class="hljs-comment">// Borramos los datos de la tabla</span>
        DB::table(<span class="hljs-string">'users'</span>)<span class="hljs-variable">-&gt;delete</span>();

        <span class="hljs-comment">// Añadimos una entrada a esta tabla</span>
        User::create(<span class="hljs-keyword">array</span>(<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'foo@bar.com'</span>));
    }
}
</code></pre>
<blockquote>
<p>Otra opción es crear métodos dentro de la clase principal <code>DatabaseSeeder</code> que se llamen desde su método <code>run</code>.</p>
</blockquote>
<p>Como se puede ver en el ejemplo en general tendremos que eliminar primero los datos de la tabla en cuestión y posteriormente añadir los datos. Para insertar datos en una tabla podemos utilizar el método que se usa en el ejemplo o alguna de las otras opciones que se verán en la sección sobre &quot;modelos de datos&quot;.</p>
<p>Una vez definidos los ficheros de semillas, cuando queramos ejecutarlos para rellenar de datos la base de datos tendremos que usar el siguiente comando de Artisan:</p>
<pre><code class="lang-bash">php artisan db:seed
</code></pre>
<!-- ************************************************************************-->
<h1 id="constructor-de-consultas-_query-builder_">Constructor de consultas (<em>Query Builder</em>)</h1>
<p>Laravel incluye una serie de clases que nos facilita la construcción de consultas y otro tipo de operaciones con la base de datos. Además, al utilizar estas clases, creamos una notación mucho más legible, compatible con todos los tipos de bases de datos soportados por Laravel y que nos previene de cometer errores o de ataques por inyección de código SQL. </p>
<!-- *************************************** -->
<h2 id="consultas">Consultas</h2>
<p>Para realizar una &quot;Select&quot; que devuelva todas las filas de una tabla utilizaremos el siguiente código: </p>
<pre><code class="lang-php"><span class="hljs-variable">$users</span> = DB::table(<span class="hljs-string">'users'</span>)<span class="hljs-variable">-&gt;get</span>();

<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$users</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$user</span>)
{
    var_dump(<span class="hljs-variable">$user</span><span class="hljs-variable">-&gt;name</span>);
}
</code></pre>
<p>En el ejemplo se utiliza el constructor <code>DB::tabla</code> indicando la tabla sobre la que se va a realizar la consulta, y por último se llama al método <code>get()</code> para obtener todas las filas de la misma.</p>
<p>Si queremos obtener un solo elemento podemos añadir una clausula <code>where</code> y usar <code>first</code> para obtener los datos:</p>
<pre><code class="lang-php"><span class="hljs-variable">$user</span> = DB::table(<span class="hljs-string">'users'</span>)<span class="hljs-variable">-&gt;where</span>(<span class="hljs-string">'name'</span>, <span class="hljs-string">'Pedro'</span>)<span class="hljs-variable">-&gt;first</span>();

var_dump(<span class="hljs-variable">$user</span><span class="hljs-variable">-&gt;name</span>);
</code></pre>
<p>En este ejemplo, la clausula <code>where</code> filtrará todas las filas cuya columna <code>name</code> sea igual a <code>Pedro</code>. Si queremos realizar otro tipo de filtrados, como columnas que tengan un valor mayor (<code>&gt;</code>), menor (<code>&lt;</code>) o distinto del indicado (<code>&lt;&gt;</code>), lo podemos indicar como segundo parámetro de la forma: </p>
<pre><code class="lang-php"><span class="hljs-variable">$users</span> = DB::table(<span class="hljs-string">'users'</span>)<span class="hljs-variable">-&gt;where</span>(<span class="hljs-string">'votes'</span>, <span class="hljs-string">'&gt;'</span>, <span class="hljs-number">100</span>)<span class="hljs-variable">-&gt;get</span>();
</code></pre>
<p>Si añadimos más clausulas <code>where</code> a la consulta por defecto se utilizará el operador lógico <code>AND</code>. En caso de que queramos utilizar el operador lógico <code>OR</code> lo tendremos que realizar de la forma: </p>
<pre><code class="lang-php"><span class="hljs-variable">$users</span> = DB::table(<span class="hljs-string">'users'</span>)
                    <span class="hljs-variable">-&gt;where</span>(<span class="hljs-string">'votes'</span>, <span class="hljs-string">'&gt;'</span>, <span class="hljs-number">100</span>)
                    <span class="hljs-variable">-&gt;orWhere</span>(<span class="hljs-string">'name'</span>, <span class="hljs-string">'Pedro'</span>)
                    <span class="hljs-variable">-&gt;get</span>();
</code></pre>
<p>También podemos utilizar los métodos <code>orderBy</code>, <code>groupBy</code> y <code>having</code> en las consultas: </p>
<pre><code class="lang-php"><span class="hljs-variable">$users</span> = DB::table(<span class="hljs-string">'users'</span>)
                    <span class="hljs-variable">-&gt;orderBy</span>(<span class="hljs-string">'name'</span>, <span class="hljs-string">'desc'</span>)
                    <span class="hljs-variable">-&gt;groupBy</span>(<span class="hljs-string">'count'</span>)
                    <span class="hljs-variable">-&gt;having</span>(<span class="hljs-string">'count'</span>, <span class="hljs-string">'&gt;'</span>, <span class="hljs-number">100</span>)
                    <span class="hljs-variable">-&gt;get</span>();
</code></pre>
<p>Si queremos indicar un <em>offset</em> o <em>limit</em> lo realizaremos mediante los métodos <code>skip</code> (para el <em>offset</em>) y <code>take</code> (para <em>limit</em>), por ejemplo: </p>
<pre><code class="lang-php"><span class="hljs-variable">$users</span> = DB::table(<span class="hljs-string">'users'</span>)<span class="hljs-variable">-&gt;skip</span>(<span class="hljs-number">10</span>)<span class="hljs-variable">-&gt;take</span>(<span class="hljs-number">5</span>)<span class="hljs-variable">-&gt;get</span>();
</code></pre>
<p>Para más información sobre la construcción de <em>Querys</em> (<em>join, insert, update, delete</em>, agregados, etc.) podéis consultar la documentación de Laravel en su sitio web: </p>
<p><a href="http://laravel.com/docs/4.2/queries" target="_blank">http://laravel.com/docs/4.2/queries</a></p>
<!-- *************************************** -->
<h2 id="transacciones">Transacciones</h2>
<p>Laravel también permite crear transacciones sobre un conjunto de operaciones:</p>
<pre><code class="lang-php">DB::transaction(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>
</span>{
    DB::table(<span class="hljs-string">'users'</span>)<span class="hljs-variable">-&gt;update</span>(<span class="hljs-keyword">array</span>(<span class="hljs-string">'votes'</span> =&gt; <span class="hljs-number">1</span>));

    DB::table(<span class="hljs-string">'posts'</span>)<span class="hljs-variable">-&gt;delete</span>();
});
</code></pre>
<p>En caso de que se produzca cualquier excepción en las operaciones que se realizan en la transacción se desharían todos los cambios aplicados hasta ese momento de forma automática. </p>
<!-- ************************************************************************-->
<h1 id="modelos-de-datos-mediante-orm">Modelos de datos mediante ORM</h1>
<p>El mapeo objeto-relacional (más conocido por su nombre en inglés, <em>Object-Relational mapping</em>, o sus siglas ORM) es una técnica de programación para convertir datos entre el sistema de tipos utilizado en un lenguaje de programación orientado a objetos y la utilización de una base de datos relacional como motor de persistencia. En la práctica esto crea una base de datos orientada a objetos virtual, sobre la base de datos relacional. Esto posibilita el uso de las características propias de la orientación a objetos (básicamente herencia y polimorfismo). </p>
<p>Laravel incluye su propio sistema de ORM llamado <em>Eloquent</em>, el cual nos proporciona una manera elegante y fácil de interactuar con la base de datos. Para esto cada tabla en la base datos debe tener su correspondiente modelo el cual se utilizará para interactuar desde código con la tabla. </p>
<p>Los modelos se guardarán como clases PHP en la carpeta <code>app/models</code>. Para definir un modelo que use <em>Eloquent</em> únicamente tenemos que crear una clase que herede de <code>Eloquent</code>:</p>
<pre><code class="lang-php"><span class="hljs-comment">// Todos los modelos tienen que extender la clase Eloquent</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Eloquent</span> </span>{}
</code></pre>
<p>En general el nombre de los modelos se pone en singular con la primera letra en mayúscula, mientras que el nombre de las tablas suele estar en plural. Gracias a esto, al definir un modelo no es necesario indicar el nombre de la tabla asociada, sino que Eloquent automáticamente buscará la tabla transformando el nombre del modelo a minúsculas y buscando su plural (en inglés). En el caso de que la tabla tuviese otro nombre lo podemos indicar definiendo la propiedad protegida <code>$table</code> del modelo: </p>
<pre><code class="lang-php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Eloquent</span> 
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$table</span> = <span class="hljs-string">'my_users'</span>;
}
</code></pre>
<p>Laravel también asume que cada tabla tiene declarada una clave primaria con el nombre <code>id</code>. En el caso de que no sea así y queramos cambiarlo tendremos que sobrescribir el valor de la propiedad protegida <code>$primaryKey</code> del modelo, por ejemplo: <code>protected $primaryKey = &#39;my_id&#39;;</code>. Es importante definir este valor ya que se utiliza en determinados métodos, como por ejemplo para buscar registros o para crear las relaciones entre modelos. </p>
<p>Otra propiedad que en ocasiones tendremos que establecer son los <em>timestamps</em> automáticos. Por defecto Eloquent asume que todas las tablas contienen los campos <code>updated_at</code> y <code>created_at</code> (los cuales los podemos añadir muy fácilmente con <em>Schema</em> añadiendo <code>$table-&gt;timestamps()</code> en la migración). Estos campos se actualizarán automáticamente cuando se cree un nuevo registro o se modifique. En el caso de que no queramos utilizarlos (y que no estén añadidos a la tabla) tendremos que indicarlo en el modelo, de otra forma nos daría un error. Para indicar que no los actualice automáticamente tendremos que modificar el valor de la propiedad pública <code>$timestamps</code> a <em>false</em>, por ejemplo: <code>public $timestamps = false;</code>.</p>
<p>A continuación se muestra un ejemplo de un modelo de <em>Eloquent</em> en el que se añaden todas las especificaciones que hemos visto: </p>
<pre><code class="lang-php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Eloquent</span> 
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$table</span> = <span class="hljs-string">'my_users'</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$primaryKey</span> = <span class="hljs-string">'my_id'</span>
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$timestamps</span> = <span class="hljs-keyword">false</span>;
}
</code></pre>
<!-- ************************************** -->
<h3 id="consultar-datos">Consultar datos</h3>
<p>Una vez creado el modelo ya podemos empezar a utilizarlo para recuperar datos de la base de datos o para actualizarlos. Por ejemplo, para obtener todas las filas de la tabla asociada a un modelo usaremos el método <code>all()</code>: </p>
<pre><code class="lang-php"><span class="hljs-variable">$users</span> = User::all();

<span class="hljs-keyword">foreach</span>( <span class="hljs-variable">$users</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$user</span> ) {
    var_dump( <span class="hljs-variable">$user</span><span class="hljs-variable">-&gt;name</span> );
}
</code></pre>
<p>Este método nos devolverá un array de resultados, donde cada item del array será una instancia del modelo <code>User</code>. Gracias a esto al obtener un elemento del array podemos acceder a los campos o columnas de la tabla como si fueran propiedades del objeto (<code>$user-&gt;name</code>).</p>
<blockquote>
<p>Nota: Todos los métodos que se describen en la sección de &quot;Constructor de consultas&quot; y en la documentación de Laravel sobre &quot;Query Builder&quot; también se pueden utilizar en los modelos Eloquent. Por lo tanto podremos utilizar <em>where, orWhere, first, get, orderBy, groupBy, having, skip, take,</em> etc. para elaborar las consultas. </p>
</blockquote>
<p>Eloquent también incorpora el método <code>find($id)</code> para buscar un elemento a partir del identificador único que tenga definido, por ejemplo: </p>
<pre><code class="lang-php"><span class="hljs-variable">$user</span> = User::find(<span class="hljs-number">1</span>);
var_dump(<span class="hljs-variable">$user</span><span class="hljs-variable">-&gt;name</span>);
</code></pre>
<p>Si queremos que se lance una excepción cuando no se encuentre un modelo podemos utilizar los métodos <code>findOrFail</code> o <code>firstOrFail</code>. Esto nos permite capturar las excepciones y mostrar un error 404 cuando sucedan.</p>
<pre><code class="lang-php"><span class="hljs-variable">$model</span> = User::findOrFail(<span class="hljs-number">1</span>);

<span class="hljs-variable">$model</span> = User::where(<span class="hljs-string">'votes'</span>, <span class="hljs-string">'&gt;'</span>, <span class="hljs-number">100</span>)<span class="hljs-variable">-&gt;firstOrFail</span>();
</code></pre>
<p>A continuación se incluyen otros ejemplos de consultas usando Eloquent con algunos de los métodos que ya habíamos visto en la sección &quot;Constructor de consultas&quot;: </p>
<pre><code class="lang-php"><span class="hljs-variable">$users</span> = User::where(<span class="hljs-string">'votes'</span>, <span class="hljs-string">'&gt;'</span>, <span class="hljs-number">100</span>)<span class="hljs-variable">-&gt;take</span>(<span class="hljs-number">10</span>)<span class="hljs-variable">-&gt;get</span>();

<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$users</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$user</span>)
{
    var_dump(<span class="hljs-variable">$user</span><span class="hljs-variable">-&gt;name</span>);
}

<span class="hljs-comment">// O para obtener el primer usuario de la lista</span>
<span class="hljs-variable">$user</span> = User::where(<span class="hljs-string">'votes'</span>, <span class="hljs-string">'&gt;'</span>, <span class="hljs-number">100</span>)<span class="hljs-variable">-&gt;first</span>();
</code></pre>
<p>También podemos utilizar los métodos agregados para calcular el total de registros obtenidos, o el máximo, mínimo, media o suma de una determinada columna. Por ejemplo: </p>
<pre><code class="lang-php"><span class="hljs-variable">$count</span> = User::where(<span class="hljs-string">'votes'</span>, <span class="hljs-string">'&gt;'</span>, <span class="hljs-number">100</span>)<span class="hljs-variable">-&gt;count</span>();
<span class="hljs-variable">$price</span> = Orders::max(<span class="hljs-string">'price'</span>);
<span class="hljs-variable">$price</span> = Orders::min(<span class="hljs-string">'price'</span>);
<span class="hljs-variable">$price</span> = Orders::avg(<span class="hljs-string">'price'</span>);
<span class="hljs-variable">$total</span> = User::sum(<span class="hljs-string">'votes'</span>);
</code></pre>
<!-- ************************************** -->
<h3 id="insertar-datos">Insertar datos</h3>
<p>Para añadir una entrada en la tabla de la base de datos asociada con un modelo simplemente tenemos que crear una nueva instancia de dicho modelo, asignar los valores que queramos y por último utilizar el método <code>save()</code>: </p>
<pre><code class="lang-php"><span class="hljs-variable">$user</span> = <span class="hljs-keyword">new</span> User;
<span class="hljs-variable">$user</span><span class="hljs-variable">-&gt;name</span> = <span class="hljs-string">'Juan'</span>;
<span class="hljs-variable">$user</span><span class="hljs-variable">-&gt;save</span>();
</code></pre>
<p>Para obtener el identificador asignado en la base de datos después de guardar (cuando se trate de tablas con índice auto-incremental), lo podremos recuperar simplemente accediendo al campo <code>id</code> del objeto que habíamos creado, por ejemplo: </p>
<pre><code class="lang-php"><span class="hljs-variable">$insertedId</span> = <span class="hljs-variable">$user</span><span class="hljs-variable">-&gt;id</span>;
</code></pre>
<!-- ************************************** -->
<h3 id="actualizar-datos">Actualizar datos</h3>
<p>Para actualizar una instancia de un modelo es muy sencillo, solo tendremos que recuperar en primer lugar la instancia que queremos actualizar, a continuación modificarla y por último guardar los datos: </p>
<pre><code class="lang-php"><span class="hljs-variable">$user</span> = User::find(<span class="hljs-number">1</span>);
<span class="hljs-variable">$user</span><span class="hljs-variable">-&gt;email</span> = <span class="hljs-string">'juan@gmail.com'</span>;
<span class="hljs-variable">$user</span><span class="hljs-variable">-&gt;save</span>();
</code></pre>
<!-- ************************************** -->
<h3 id="borrar-datos">Borrar datos</h3>
<p>Para borrar una instancia de un modelo en la base de datos simplemente tenemos que usar su método <code>delete()</code>: </p>
<pre><code class="lang-php"><span class="hljs-variable">$user</span> = User::find(<span class="hljs-number">1</span>);
<span class="hljs-variable">$user</span><span class="hljs-variable">-&gt;delete</span>();
</code></pre>
<p>Si por ejemplo queremos borrar un conjunto de resultados también podemos usar el método <code>delete()</code> de la forma: </p>
<pre><code class="lang-php"><span class="hljs-variable">$affectedRows</span> = User::where(<span class="hljs-string">'votes'</span>, <span class="hljs-string">'&gt;'</span>, <span class="hljs-number">100</span>)<span class="hljs-variable">-&gt;delete</span>();
</code></pre>
<!-- ************************************** -->
<h3 id="ms-informacin">Más información</h3>
<p>Para más información sobre como crear relaciones entre modelos, <em>eager loading</em>, etc. podéis consultar directamente la documentación de Laravel en:</p>
<p><a href="http://laravel.com/docs/4.2/eloquent" target="_blank">http://laravel.com/docs/4.2/eloquent</a></p>
<!-- ************************************************************************-->
<!-- ************************************************************************-->
<!-- ************************************************************************-->
<!-- ************************************************************************-->
<!-- ************************************************************************-->
<h1 id="ejercicios">Ejercicios</h1>
<p>En estos ejercicios vamos a continuar con el proyecto del videoclub que habíamos empezado en sesiones anteriores y le añadiremos todo lo referente a la gestión de la base de datos. </p>
<!-- ************************************ -->
<h1 id="ejercicio-1---configuracin-de-la-base-de-datos-y-migraciones-1-punto">Ejercicio 1 - Configuración de la base de datos y migraciones (1 punto)</h1>
<p>En este primer ejercicio en primer lugar vamos a configurar correctamente la base de datos. Para esto tenemos que ir al fichero <code>app/config/database.php</code> e indicar que vamos a usar una base de datos de MySQL llamada &quot;videoclub&quot;. Además tendremos que añadir nuestro nombre de usuario y contraseña. </p>
<blockquote>
<p>Nota: XAMPP por defecto crea el usuario de base de datos <em>root</em> sin contraseña. </p>
</blockquote>
<p>Ahora tendremos que abrir PHPMyAdmin y crear esta base de datos para poder empezar a trabajar con ella. Para comprobar que todo se ha configurado correctamente abrimos un terminal en la carpeta de nuestro proyecto y ejecutamos el comando que crea la tabla de migraciones. Si todo va bien podremos actualizar desde PHPMyAdmin y comprobar que se ha creado esta tabla dentro de nuestra nueva base de datos. </p>
<p>A continuación vamos a crear la tabla que utilizaremos para almacenar el catálogo de películas. Ejecuta el comando de artisan para crear la migración llamada <code>create_movies_table</code> para la tabla <code>movies</code>. Una vez creado edita este fichero para añadir todos los campos necesarios, estos son: </p>
<table>
<thead>
<tr>
<th>Campo</th>
<th>Tipo</th>
<th>Valor por defecto</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>Autoincremental</td>
<td></td>
</tr>
<tr>
<td>title</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>year</td>
<td>String de longitud 8</td>
<td></td>
</tr>
<tr>
<td>director</td>
<td>String de longitud 64</td>
<td></td>
</tr>
<tr>
<td>poster</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>rented</td>
<td>Booleano</td>
<td>false</td>
</tr>
<tr>
<td>synopsis</td>
<td>Text</td>
<td></td>
</tr>
<tr>
<td>timestamps</td>
<td>Timestamps de Eloquent</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Recuerda que en el método <code>down</code> de la migración tienes que deshacer los cambios que has hecho en el método <code>up</code>, en este caso sería eliminar la tabla.</p>
</blockquote>
<p>Por último ejecutaremos el comando de artisan que añade las nuevas migraciones y comprobaremos en PHPMyAdmin que la tabla se ha creado correctamente con los campos que le hemos indicado. </p>
<!-- ************************************ -->
<h1 id="ejercicio-2---modelo-de-datos-05-puntos">Ejercicio 2 - Modelo de datos (0.5 puntos)</h1>
<p>En este ejercicio vamos a crear el modelo de datos asociado con la tabla <em>movies</em>. Para esto crearemos un nuevo fichero PHP llamado <code>Movie.php</code> en la carpeta <code>app/models</code> con las siguientes características: </p>
<ul>
<li>El modelo tiene que heredar de la clase <code>Eloquent</code>.</li>
</ul>
<p>Nada más, el cuerpo de la clase puede estar vacío (<code>{}</code>), todo lo demás se hace automáticamente!</p>
<!-- ************************************ -->
<h1 id="ejercicio-3---semillas-1-punto">Ejercicio 3 - Semillas (1 punto)</h1>
<p>Ahora vamos a proceder a rellenar la tabla de la base de datos con los datos iniciales. Para esto editamos el fichero de semillas situado en <code>app/database/seeds/DatabaseSeeder.php</code> y seguiremos los siguientes pasos: </p>
<ul>
<li><p>Creamos un método privado (dentro de la misma clase) llamado <code>seedCatalog()</code> que se tendrá que llamar desde el método <code>run</code> de la forma: 
<br/></p>
<pre><code class="lang-php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">self</span>::seedCatalog();
  <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;command</span><span class="hljs-variable">-&gt;info</span>(<span class="hljs-string">'Tabla catálogo inicializada con datos!'</span>);
}
</code></pre>
</li>
<li><p>Movemos el array de películas que se facilitaba en los materiales y que habíamos copiado dentro del controlador <code>CatalogController</code> a la clase de semillas (<code>DatabaseSeeder.php</code>), guardándolo de la misma forma, como variable privada de la clase. </p>
</li>
<li><p>Dentro del nuevo método <code>seedCatalog()</code> realizamos las siguientes acciones: </p>
<ul>
<li>En primer lugar borramos el contenido de la tabla <code>movies</code> con <code>DB::table(&#39;movies&#39;)-&gt;delete();</code>. </li>
<li>Y a continuación añadimos el siguiente código: 
<br/><pre><code class="lang-php"><span class="hljs-keyword">foreach</span>( <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;arrayPeliculas</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$pelicula</span> ) {
<span class="hljs-variable">$p</span> = <span class="hljs-keyword">new</span> Movie;
<span class="hljs-variable">$p</span><span class="hljs-variable">-&gt;title</span> = <span class="hljs-variable">$pelicula</span>[<span class="hljs-string">'title'</span>];
<span class="hljs-variable">$p</span><span class="hljs-variable">-&gt;year</span> = <span class="hljs-variable">$pelicula</span>[<span class="hljs-string">'year'</span>];
<span class="hljs-variable">$p</span><span class="hljs-variable">-&gt;director</span> = <span class="hljs-variable">$pelicula</span>[<span class="hljs-string">'director'</span>];
<span class="hljs-variable">$p</span><span class="hljs-variable">-&gt;poster</span> = <span class="hljs-variable">$pelicula</span>[<span class="hljs-string">'poster'</span>];
<span class="hljs-variable">$p</span><span class="hljs-variable">-&gt;rented</span> = <span class="hljs-variable">$pelicula</span>[<span class="hljs-string">'rented'</span>];
<span class="hljs-variable">$p</span><span class="hljs-variable">-&gt;synopsis</span> = <span class="hljs-variable">$pelicula</span>[<span class="hljs-string">'synopsis'</span>];
<span class="hljs-variable">$p</span><span class="hljs-variable">-&gt;save</span>();
}
</code></pre>
</li>
</ul>
</li>
</ul>
<p>Por último tendremos que ejecutar el comando de artisan que procesa las semillas y una vez realizado abriremos PHPMyAdmin para comprobar que se rellenado la tabla <em>movies</em> con el listado de películas. </p>
<!-- ************************************ -->
<h1 id="ejercicio-4---uso-de-la-base-de-datos-1-punto">Ejercicio 4 - Uso de la base de datos (1 punto)</h1>
<p>En este último ejercicio vamos a actualizar los métodos del controlador <code>CatalogController</code> para que obtengan los datos de la base de datos: </p>
<ul>
<li>Modificar el método <code>getIndex</code> para que obtenga toda la lista de películas de la base de datos (usando el modelo <code>Movie</code>) y se la pase a la vista. </li>
<li>Modificar el método <code>getShow</code> para que obtenga la película pasada por parámetro usando el método <code>findOrFail</code> y se la pase a la vista. </li>
<li>Modificar el método <code>getEdit</code> para que obtenga la película pasada por parámetro usando el método <code>findOrFail</code> y se la pase a la vista. </li>
</ul>
<p>Ahora tendremos que actualizar las vistas para que en lugar de acceder a los datos del array los obtenga del objeto con la película. Para esto cambiaremos en todos los sitios donde hayamos puesto <code>$pelicula[&#39;campo&#39;]</code> por <code>$pelicula-&gt;campo</code>. </p>
<p>Además, en la vista <code>catalog/index.blade.php</code>, en vez de utilizar el índice del array como identificador para crear el enlace a <code>catalog/show/{id}</code>, tendremos que utilizar el campo <code>id</code> de la película. Lo mismo en la vista <code>catalog/show.blade.php</code>, para generar el enlace de editar película tendremos que añadir el identificador de la película a la ruta <code>catalog/edit</code>. </p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="./capitulo_laravel_2.html" class="navigation navigation-prev " aria-label="Previous page: Laravel 2. Controladores, filtros y formularios"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="./capitulo_laravel_4.html" class="navigation navigation-next " aria-label="Next page: Laravel 4. Datos de entrada y control de usuarios"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
